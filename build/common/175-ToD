echo -e "[$SCRIPT]: Fix Time of Day tabs"
sed \
  -e 's/T"Time of day access control"/T"Device Access Control"/' \
  -e 's/Create New Rule/Add New Rule/' \
  -e "/update\">\\\/a ');" \
  -e '/update">\\/a local lp = require("web.lp")' \
  -e '/update">\\/a lp.setpath("/www/snippets/")' \
  -e '/update">\\/a lp.include("tabs-tod.lp")' \
  -e "/update\">\\\/a ngx.print('\\\\" \
  -e "/^<div style=\"padding-top: 0px; padding-left: 20px;\" >/,/^<\/div>/d" \
  -i /www/docroot/modals/tod-modal.lp

echo -e "[$SCRIPT]: Restart Time of Day processing after updates applied"
sed -e 's|reload$|reload; /etc/init.d/tod restart;|' -i /usr/share/transformer/commitapply/uci_tod.ca
SRV_transformer=$(( $SRV_transformer + 1 ))

if [ -z "$(uci get -q tod.voicednd)" ]; then
  echo -e "[$SCRIPT]: Add missing Time of Day Do Not Disturb configuration"
  uci set tod.voicednd=tod
  uci set tod.voicednd.ringing='off'
  uci set tod.voicednd.timerandactionmodified='0'
  uci set tod.voicednd.enabled='0'
  uci commit tod
fi

echo -e "[$SCRIPT]: Update Time of Day commit/apply to enable Do Not Disturb processing"
sed \
  -e '$a\^uci.tod.todvoicednd.ringing /usr/bin/lua /usr/share/transformer/scripts/voice_tod.lua' \
  -e '$a\^uci.tod.todvoicednd.enabled /usr/bin/lua /usr/share/transformer/scripts/voicednd_toggle.lua' \
  -i /usr/share/transformer/commitapply/uci_tod.ca
SRV_transformer=$(( $SRV_transformer + 1 ))

if [ "$MINIFY" = y ]; then
  echo -e "[$SCRIPT]: Pre-minify fixes"
  [ -n "$VERBOSE" ] && echo -e "[$SCRIPT]: - Fixing /www/docroot/modals/tod_wireless-modal.lp"
  sed \
    -e '/ui_helper adds dummy hidden checkbox if no checkboxes are checked./d' \
    -i /www/docroot/modals/tod_wireless-modal.lp
fi
